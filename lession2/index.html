<!DOCTYPE html>
<html lang="ko">
<head>
<title>bsidesoft broadcast lession 2</title>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="format-detection" content="telephone=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"/>
</head>
<body>
<canvas id="stage" width="500" height="500"></canvas>
<script>
var getId;
getId = (function(){
  var cache = {};
  return function(id){
    var el;
    return cache[id] || (el = document.getElementById(id)) && (cache[id] = el);
  };
})();
var context = getId('stage').getContext('2d');

var Display = (function(){
  var que = [];
  var Display = function(){};
  //override
  Display.prototype._path = function(){
    throw '_path';
  };
  Display.prototype.makePath = (function(){
    var cmd = [];
    return function(context){
      var i, j;
      cmd.length = 0;
      this._path(cmd);
      i = 0, j = cmd.length;
      que.push(context, 'beginPath', null);
      while(i < j){
        que.push(context, cmd[i++], cmd[i++]);
      }
      que.push(context, 'closePath', null);
    };
  })();
  Display.prototype.stroke = function(context, r,g,b,a){
    this.makePath(context);
    que.push(
      context, 'strokeStyle', 'rgba(' + [r,g,b,a].join(',') + ')',
      context, 'stroke', null
    );
  };
  Display.prototype.fill = function(context, r,g,b,a){
    this.makePath(context);
    que.push(
      context, 'fillStyle', 'rgba(' + [r,g,b,a].join(',') + ')',
      context, 'fill', null
    );
  };
  Display.render = function(){
    //[context1, method, arguments, context2, method, arguments,...]
    var clearList = [], canvas, context, prop, param, i, j;
    //clear each canvas
    for(i = 0, j = que.length; i < j; i += 3){
      if(clearList.indexOf(que[i]) == -1){
        clearList.push(que[i]);
        canvas = que[i].canvas;
        que[i].clearRect(0, 0, canvas.width, canvas.height);
      }
    }
    //render object
    i = 0, j = que.length;
    while(i < j){
      context = que[i++];
      prop = que[i++];
      param = que[i++];
      if(typeof context[prop] == 'function') context[prop].apply(context, param);
      else context[prop] = param;
    }
    que.length = 0;
  };
  return Display;
})();
var Box = function(x, y, w, h){
  this.x = x;
  this.y = y;
  this.width = w;
  this.height = h;
};
Box.prototype = new Display();
Box.prototype._path = function(command){
  command.push(
    'moveTo', [this.x, this.y],
    'lineTo', [this.x + this.width, this.y],
    'lineTo', [this.x + this.width, this.y + this.height],
    'lineTo', [this.x, this.y + this.height],
    'lineTo', [this.x, this.y]
  );
  return command;
};
var Triangle = function(x, y, w, h){
  this.x = x;
  this.y = y;
  this.width = w;
  this.height = h;
};
Triangle.prototype = new Display();
Triangle.prototype._path = function(command){
  command.push(
    'moveTo', [this.x, this.y + this.height],
    'lineTo', [this.x + this.width/2, this.y],
    'lineTo', [this.x + this.width, this.y + this.height],
    'lineTo', [this.x, this.y + this.height]
  );
  return command;
};
var Circle = function(x, y, r){
  this.x = x;
  this.y = y;
  this.radius = r;
};
Circle.prototype = new Display();
Circle.prototype._path = function(command){
  command.push(
    'arc', [this.x, this.y, this.radius, 0, 2 * Math.PI]
  );
  return command;
};
var box1 = new Box(100,100, 20,20);
var box2 = new Box(300,300, 50,50);

//---------------------
requestAnimationFrame(function loop(t){
  var x, y;
  box1.x = Math.random()*400 + 50;
  box1.y = Math.random()*400 + 50;
  box1.fill(context, 255,0,0,1);
  box2.x = Math.random()*400 + 50;
  box2.y = Math.random()*400 + 50;
  box2.stroke(context, 0,0,255,1);
  Display.render();
  requestAnimationFrame(loop);
});
</script>
</body>
</html>
